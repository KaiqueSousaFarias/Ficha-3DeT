<?xml version="1.0" encoding="UTF-8"?>
<form name="Geral" align="client">
	<script>
        <![CDATA[

            local function basicRoll(text, var, nvNeg)
	        	local mod = tonumber(sheet[var]) or 0
                if nvNeg then
                    mod = mod - math.abs(tonumber(sheet.nvNeg) or 0)
                end
				local rolagem = Firecast.interpretarRolagem("1d6+" .. mod)
				if mod < 0 then
					rolagem = Firecast.interpretarRolagem("1d6" .. mod)
				end
				local mesa = Firecast.getMesaDe(sheet)
				mesa.activeChat:rolarDados(rolagem, text .. " de " .. (sheet.nome or "Nome"))
	        end

	        local function basicRoll2(text, var)
	        	local mod = tonumber(sheet[var]) or 0
				local rolagem = Firecast.interpretarRolagem("1d6")
				if mod < 0 then
					rolagem = Firecast.interpretarRolagem("1d6")
				end
				local mesa = Firecast.getMesaDe(sheet)
				mesa.activeChat:rolarDados(rolagem, text .. " de " .. (sheet.nome or "Nome") .. " (Modificador: " .. mod .. ")")
	        end

	        local function ShowPopUp(popup, location, position)
				local pop = self:findControlByName(popup)
				
				if pop ~= nil then
					pop:setNodeObject(self.sheet)
					pop:showPopupEx((position or "rightCenter"), location)
				else
					showMessage("Ops, bug.. nao encontrei o popup " .. popup .. " para exibir")
				end
	        end


        ]]>
    </script>

    <scrollBox align="client" g-cnt-line-spacing="5">
		<!-- Logo da Mesa -->
		<rectangle g="col" g-width="12" g-width-lg="2" color="black" strokeColor="white" strokeSize="1" padding="{left=5,right=5,top=5,bottom=5}" g-min-height="110">
			<label horzTextAlign="center" align="client"/>
			<image align="client" field="logoMesa" editable="true" style="proportional" >
				<event name="OnStartDrag">
			    drag:addData("imageURL", sheet.logoMesa)
				</event>
			</image>
		</rectangle>

		<!-- Title region -->
		<rectangle g="col" g-width="10" g-width-lg="8" color="black" strokeColor="white" strokeSize="1" g-min-height="110" padding="{left=5,right=5,top=5,bottom=5}">
			<Title text="JOGADOR" field="jogador"/>
			<Title text="NOME" field="nome"/>
			<Title text="RAÇA" field="raca"/>
			<Title text="TITULO" field="posto"/>
		</rectangle>

		<rectangle g="col" g-width="2" g-width-lg="2" color="black" strokeColor="white" strokeSize="1" g-min-height="110" padding="{left=5,right=5,top=5,bottom=5}" g-break-line-after="true">
				<label align="top" height="25" text="Pontos" margins="{left=5,right=5}"/>
				<edit align="top" height="25" field="pontos" margins="{left=5,right=5}"/>
				<label align="top" height="25" text="XP" margins="{left=5,right=5}"/>
				<edit align="top" height="25" field="experiencia" margins="{left=5,right=5}"/>
		</rectangle>

		<!-- Details -->
<!--		<layout g="col" g-width="12" g-width-lg="3" g-min-height="415" g-cnt-line-spacing="5">-->
			<rectangle g="col" g-width="12" g-width-lg="3" color="black" strokeColor="white" strokeSize="1" padding="{left=5,right=5,top=5,bottom=5}" g-min-height="185">
				<label g="col" g-width="12" text="CARACTERÍSTICAS" horzTextAlign="center" height="25"/>

				<layout g="col" g-width="11" g-min-height="175">
					<label g="col" g-width="4" g-offset="4" text="Real" horzTextAlign="center" height="25"/>
					<label g="col" g-width="4" text="Efetivo" horzTextAlign="center" height="25"/>

					<Attribute atr="For" atrN="Força" num="1"/>
					<Attribute atr="Hab" atrN="Habilidade" num="2"/>
					<Attribute atr="Res" atrN="Resistência" num="3"/>
					<Attribute atr="Arm" atrN="Armadura" num="4"/>
					<Attribute atr="PdF" atrN="Poder de Fogo" num="5"/>
				</layout>
				<button g="col" g-width="1" g-min-height="125" name="AtrBut" text="🔍" margins="{top=25}" onClick="ShowPopUp('popAttribute', self.AtrBut)" hint="Detalhes" textTrimming="none"/>
			</rectangle>
<!--		</layout>-->

<!--		<layout g="col" g-width="12" g-width-lg="3" g-min-height="415" g-cnt-line-spacing="5">-->
			<rectangle g="col" g-width="12" g-width-lg="3" color="black" strokeColor="white" strokeSize="1" padding="{left=5,right=5,top=5,bottom=5}" g-min-height="185">
				<label g="col" g-width="12" text="COMBATE" horzTextAlign="center" height="25"/>
				<!-- Valor Total-->
				<label g="col" g-width="4" g-offset="6" text="Total" horzTextAlign="center" height="25"/>
				<label g="col" g-width="2" text="Adicional" horzTextAlign="center" height="25"/>

				<!-- Iniciativa -->
				<TitleButtonLabel2Edit text="Iniciativa" field1="iniciativa" field2="efetModHab" field3="iniVariado" onClick="basicRoll('Teste de Iniciativa','iniciativa')"/>

				<dataLink fields="{'efetModHab', 'iniVariado'}">
					<event name="onUserChange">
						if sheet~= nil then
						local mod = (tonumber(sheet.efetModHab) or 0) + (tonumber(sheet.iniVariado) or 0)
						if (mod >= 0) then
						mod = "+" .. mod
						end
						sheet.iniciativa = mod
						end
					</event>
				</dataLink>

				<!-- Força de Ataque (FA) -->
				<TitleButtonLabel2Edit text="Força de Ataque (FOR)" field1="forcaDeAtaqueF" field2="efetModFor" field3="forVariado" onClick="basicRoll('Teste de Força de Ataque','forcaDeAtaqueF')"/>

				<dataLink fields="{'efetModFor', 'forVariado'}">
					<event name="onUserChange">
						if sheet~= nil then
						local mod = (tonumber(sheet.efetModHab) or 0) + (tonumber(sheet.efetModFor) or 0) + (tonumber(sheet.forVariado) or 0)
						if (mod >= 0) then
						mod = "+" .. mod
						end
						sheet.forcaDeAtaqueF = mod
						end
					</event>
				</dataLink>

				<!-- Força de Ataque (FA) -->
				<TitleButtonLabel2Edit text="Força de Ataque (PDF)" field1="forcaDeAtaquePdF" field2="efetModPdF" field3="pdfVariado" onClick="basicRoll('Teste de Força de Ataque','forcaDeAtaquePdF')"/>

				<dataLink fields="{'efetModPdF', 'pdfVariado'}">
					<event name="onUserChange">
						if sheet~= nil then
						local mod = (tonumber(sheet.efetModHab) or 0) + (tonumber(sheet.efetModPdF) or 0) + (tonumber(sheet.pdfVariado) or 0)
						if (mod >= 0) then
						mod = "+" .. mod
						end
						sheet.forcaDeAtaquePdF = mod
						end
					</event>
				</dataLink>

				<!-- Esquiva -->
				<TitleButtonLabel3Edit text="Esquiva" field1="esquiva" field2="efetModHab" field3="esqVariado" onClick="basicRoll2('Teste de Esquiva','esquiva')"/>
				<dataLink fields="{'efetModHab', 'esqVariado'}">
					<event name="onUserChange">
						if sheet~= nil then
						local mod = (tonumber(sheet.efetModHab) or 0) + (tonumber(sheet.esqVariado) or 0)
						if (mod >= 0) then
						mod = "+" .. mod
						end
						sheet.esquiva = mod
						end
					</event>
				</dataLink>

				<!--  Força de Defesa (FD) -->
				<TitleButtonLabel2Edit text="Força de Defesa (FD)" field1="forcaDefesa" field2="efetModArm" field3="fdVariado" onClick="basicRoll('Teste de Força de Defesa','forcaDefesa')"/>
				<dataLink fields="{'efetModArm', 'fdVariado'}">
					<event name="onUserChange">
						if sheet~= nil then
						local mod = (tonumber(sheet.efetModArm) or 0) + (tonumber(sheet.efetModHab) or 0) + (tonumber(sheet.fdVariado) or 0)
						if (mod >= 0) then
						mod = "+" .. mod
						end
						sheet.forcaDefesa = mod
						end
					</event>
				</dataLink>

			</rectangle>
<!--		</layout>-->

<!--		<layout g="col" g-width="6" g-width-lg="3" g-min-height="415" g-cnt-line-spacing="5">-->
			<rectangle g="col" g-width="12" g-width-lg="3" color="black" strokeColor="white" strokeSize="1" padding="{left=5,right=5,top=5,bottom=5}" g-min-height="185">
				<label g="col" g-width="12" text="DESLOCAMENTOS" horzTextAlign="center" height="25"/>

				<label g="col" g-width="4" g-offset="4" text="Metros" horzTextAlign="center" height="25"/>
				<label g="col" g-width="4" text="Quadrados" horzTextAlign="center" height="25"/>

				<Speed text="TERRESTRE" mode="Terrestre"/>
				<Speed text="VOO" mode="Voo"/>
				<Speed text="NATAÇÃO" mode="Natacao"/>
				<Speed text="ESCALAR" mode="Escalar"/>
				<Speed text="ESCAVAR" mode="Escavar"/>
			</rectangle>
<!--		</layout>-->


		<rectangle g="col" g-width="6" g-width-lg="3" color="black" strokeColor="white" strokeSize="1" padding="{left=5,right=5,top=5,bottom=5}" g-min-height="415">
			<label horzTextAlign="center" align="client"/>
			<image align="client" field="avatar" editable="true" style="proportional" >
				<event name="OnStartDrag">
				    drag:addData("imageURL", sheet.avatar)
				</event>
			</image>
		</rectangle>
	</scrollBox>
</form>